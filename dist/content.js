const l='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>',c='<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';let a=new Set;async function d(){try{const n=(await chrome.storage.local.get(["tweets"])).tweets||[];a=new Set(n.map(e=>e.url))}catch(t){console.error("Error loading captured URLs:",t)}}chrome.storage.onChanged.addListener(t=>{if(t.tweets?.newValue){const n=t.tweets.newValue;a=new Set(n.map(e=>e.url)),f()}});function p(t){const n=t.querySelector('a[role="link"][href^="/"]'),e=t.querySelector('a[href*="/status/"]')?.getAttribute("href");if(!e)return null;const r=[];t.querySelectorAll('[data-testid="tweetPhoto"] img').forEach(u=>{const i=u.src;i&&!i.includes("profile_images")&&r.push(i.split("?")[0]+"?format=jpg&name=large")});const o=!!t.querySelector("video"),s=`https://twitter.com${e}`;return{id:Date.now().toString()+Math.random().toString(36).substr(2,9),userName:n?.textContent?.trim()||"",userHandle:n?.getAttribute("href")||"",text:t.querySelector('[data-testid="tweetText"]')?.textContent||"",images:r,videoUrl:o?s:"",url:s,timestamp:t.querySelector("time")?.getAttribute("datetime")||new Date().toISOString(),captured:new Date().toISOString()}}async function w(t){try{const e=(await chrome.storage.local.get(["tweets"])).tweets||[];return e.some(r=>r.url===t.url)?!1:(e.unshift(t),await chrome.storage.local.set({tweets:e}),a.add(t.url),!0)}catch(n){return console.error("Error saving tweet:",n),!1}}function h(t,n){const e=a.has(t),r=document.createElement("button");return r.className="twitter-capture-btn"+(e?" captured":""),r.innerHTML=e?`${c}<span>已抓取</span>`:`${l}<span>抓取</span>`,r.title=e?"已抓取此推文":"抓取推文",r.disabled=e,r.dataset.tweetUrl=t,e||(r.onclick=async o=>{o.preventDefault(),o.stopPropagation();const s=p(n);if(!s)return;await w(s)&&(r.classList.add("captured"),r.innerHTML=`${c}<span>已抓取</span>`,r.disabled=!0,r.title="已抓取此推文")}),r}function f(){document.querySelectorAll(".twitter-capture-btn").forEach(t=>{const n=t.dataset.tweetUrl;n&&a.has(n)&&(t.classList.add("captured"),t.innerHTML=`${c}<span>已抓取</span>`,t.disabled=!0,t.setAttribute("title","已抓取此推文"))})}function m(){new MutationObserver(()=>{document.querySelectorAll('article[data-testid="tweet"]').forEach(t=>{if(t.querySelector(".twitter-capture-btn"))return;const n=t.querySelector('[role="group"]');if(!n)return;const e=t.querySelector('a[href*="/status/"]')?.getAttribute("href");if(!e)return;const r=`https://twitter.com${e}`,o=h(r,t),s=document.createElement("div");s.className="twitter-capture-container",s.appendChild(o),n.appendChild(s)})}).observe(document.body,{childList:!0,subtree:!0})}d().then(()=>m());
